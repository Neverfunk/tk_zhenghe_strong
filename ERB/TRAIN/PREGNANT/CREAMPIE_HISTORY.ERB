;---------------------------------------------------------
;中出し履歴を更新する関数
;古くなった履歴を削除する
;---------------------------------------------------------
@UPDATE_CREAMPIE_HISTORY(ARG)
#DIM LCOUNT
FOR LCOUNT, 0, WOMB_RECORD_MAX
	SIF WOMB_SPERM_ID:ARG:LCOUNT == 0
		CONTINUE
	;最終中出し日からの期間を加算
	WOMB_SPERM_TIME:ARG:LCOUNT ++

	;減算処理
	IF WOMB_SPERM_AMOUNT:ARG:LCOUNT > CALC_WOMB_SIZE(ARG) / 5 || WOMB_SPERM_COUNT:ARG:LCOUNT >= 5
		LOCAL:1 = RAND:MAX(WOMB_SPERM_COUNT:ARG:LCOUNT / 3, 1)
		WOMB_SPERM_AMOUNT:ARG:LCOUNT = MIN_DECREASE(WOMB_SPERM_AMOUNT:ARG:LCOUNT, WOMB_SPERM_AMOUNT:ARG:LCOUNT * LOCAL:1 / WOMB_SPERM_COUNT:ARG:LCOUNT, 0)
		WOMB_SPERM_COUNT:ARG:LCOUNT -= LOCAL:1
	ENDIF

	;履歴が古い、量と発数が0を割ったらリストから削除
	IF WOMB_SPERM_TIME:ARG:LCOUNT >= 3 || WOMB_SPERM_AMOUNT:ARG:LCOUNT <= 0 || WOMB_SPERM_COUNT:ARG:LCOUNT <= 0
		WOMB_SPERM_ID:ARG:LCOUNT = 0
		WOMB_SPERM_AMOUNT:ARG:LCOUNT = 0
		WOMB_SPERM_TIME:ARG:LCOUNT = 0
		WOMB_SPERM_COUNT:ARG:LCOUNT = 0
	ENDIF
NEXT

FOR LCOUNT, 0, WOMB_RECORD_MAX
	SIF STOMACH_SPERM_ID:ARG:LCOUNT == 0
		CONTINUE
	;最終中出し日からの期間を加算
	STOMACH_SPERM_TIME:ARG:LCOUNT ++

	;減算処理
	IF STOMACH_SPERM_AMOUNT:ARG:LCOUNT > CALC_STOMACH_SIZE(ARG) / 5 || STOMACH_SPERM_COUNT:ARG:LCOUNT >= 5
		LOCAL:1 = RAND:MAX(STOMACH_SPERM_COUNT:ARG:LCOUNT / 3, 1)
		STOMACH_SPERM_AMOUNT:ARG:LCOUNT = MIN_DECREASE(STOMACH_SPERM_AMOUNT:ARG:LCOUNT, STOMACH_SPERM_AMOUNT:ARG:LCOUNT * LOCAL:1 / STOMACH_SPERM_COUNT:ARG:LCOUNT, 0)
		STOMACH_SPERM_COUNT:ARG:LCOUNT -= LOCAL:1
	ENDIF

	;履歴が古い、量と発数が0を割ったらリストから削除
	IF STOMACH_SPERM_TIME:ARG:LCOUNT >= 3 || STOMACH_SPERM_AMOUNT:ARG:LCOUNT <= 0 || STOMACH_SPERM_COUNT:ARG:LCOUNT <= 0
		STOMACH_SPERM_ID:ARG:LCOUNT = 0
		STOMACH_SPERM_AMOUNT:ARG:LCOUNT = 0
		STOMACH_SPERM_TIME:ARG:LCOUNT = 0
		STOMACH_SPERM_COUNT:ARG:LCOUNT = 0
	ENDIF
NEXT

FOR LCOUNT, 0, WOMB_RECORD_MAX
	SIF ANUS_SPERM_ID:ARG:LCOUNT == 0
		CONTINUE
	;最終中出し日からの期間を加算
	ANUS_SPERM_TIME:ARG:LCOUNT ++

	;減算処理
	IF ANUS_SPERM_AMOUNT:ARG:LCOUNT > CALC_ANUS_SIZE(ARG) / 5 || ANUS_SPERM_COUNT:ARG:LCOUNT >= 5
		LOCAL:1 = RAND:MAX(ANUS_SPERM_COUNT:ARG:LCOUNT / 3, 1)
		ANUS_SPERM_AMOUNT:ARG:LCOUNT = MIN_DECREASE(ANUS_SPERM_AMOUNT:ARG:LCOUNT, ANUS_SPERM_AMOUNT:ARG:LCOUNT * LOCAL:1 / ANUS_SPERM_COUNT:ARG:LCOUNT, 0)
		ANUS_SPERM_COUNT:ARG:LCOUNT -= LOCAL:1
	ENDIF

	;履歴が古い、量と発数が0を割ったらリストから削除
	IF ANUS_SPERM_TIME:ARG:LCOUNT >= 3 || ANUS_SPERM_AMOUNT:ARG:LCOUNT <= 0 || ANUS_SPERM_COUNT:ARG:LCOUNT <= 0
		ANUS_SPERM_ID:ARG:LCOUNT = 0
		ANUS_SPERM_AMOUNT:ARG:LCOUNT = 0
		ANUS_SPERM_TIME:ARG:LCOUNT = 0
		ANUS_SPERM_COUNT:ARG:LCOUNT = 0
	ENDIF
NEXT


;---------------------------------------------------------
;父親候補を履歴から探す関数
;妊娠している時点で父親はいるはずなので候補が0人である場合は一応エラーを投げて父親が不明ということにする
;RETURNF CASE
	;0:候補が複数など候補が1人でない場合
	;else:父親候補の番号
;---------------------------------------------------------
@GET_FATHER_CANDIDATE_FROM_CREAMPIE_HISTORY(ARG)
#FUNCTION
#DIM FATHER_CANDIDATE, WOMB_RECORD_MAX
#DIM SPERM_AMOUNT_SUM
#DIM CANDIDATE_COUNT
#DIM CANDIDATE_CNO
#DIM CANDIDATE_VALUE
#DIM LCOUNT
VARSET CANDIDATE_COUNT
VARSET FATHER_CANDIDATE
VARSET SPERM_AMOUNT_SUM

FOR LCOUNT, 0, WOMB_RECORD_MAX
	SIF WOMB_SPERM_ID:ARG:LCOUNT == 0
		CONTINUE
	CANDIDATE_CNO = ID_TO_CHARA(WOMB_SPERM_ID:ARG:LCOUNT)
	FATHER_CANDIDATE:CANDIDATE_COUNT = WOMB_SPERM_ID:ARG:LCOUNT
	IF CANDIDATE_CNO >= 0
		SPERM_AMOUNT_SUM += WOMB_SPERM_AMOUNT:ARG:LCOUNT * (GETBIT(TALENT:CANDIDATE_CNO:淫乱系, 素質_淫乱_濃厚精液) + 1)
	ELSE
		;動物の精液は大量なため、1mlあたりの効果量を引き下げる
		IF IS_ANIMAL_SPERM(WOMB_SPERM_ID:ARG:LCOUNT)
			SPERM_AMOUNT_SUM += WOMB_SPERM_AMOUNT:ARG:LCOUNT / 5
		ELSE
			SPERM_AMOUNT_SUM += WOMB_SPERM_AMOUNT:ARG:LCOUNT
		ENDIF
	ENDIF
	CANDIDATE_COUNT ++
NEXT

SIF CANDIDATE_COUNT == 0
	CALLF ERROR

;父親が複数いる場合はランダムにする
;SIF CANDIDATE_COUNT != 1
;	RETURNF 0

IF CANDIDATE_COUNT == 1 || RAND:CANDIDATE_COUNT > 0
	CANDIDATE_VALUE = RAND:SPERM_AMOUNT_SUM
	FOR LCOUNT, 0, WOMB_RECORD_MAX
		CANDIDATE_CNO = ID_TO_CHARA(WOMB_SPERM_ID:ARG:LCOUNT)
		IF CANDIDATE_CNO >= 0
			CANDIDATE_VALUE -= WOMB_SPERM_AMOUNT:ARG:LCOUNT * (GETBIT(TALENT:CANDIDATE_CNO:淫乱系, 素質_淫乱_濃厚精液) + 1)
		ELSE
			;動物の精液は大量なため、1mlあたりの効果量を引き下げる
			IF IS_ANIMAL_SPERM(WOMB_SPERM_ID:ARG:LCOUNT)
				CANDIDATE_VALUE -= WOMB_SPERM_AMOUNT:ARG:LCOUNT / 200
			ELSE
				CANDIDATE_VALUE -= WOMB_SPERM_AMOUNT:ARG:LCOUNT
			ENDIF
			CANDIDATE_VALUE -= WOMB_SPERM_AMOUNT:ARG:LCOUNT
		ENDIF
		SIF CANDIDATE_VALUE <= 0
			RETURNF WOMB_SPERM_ID:ARG:LCOUNT
	NEXT
;父親候補が複数いる場合、(候補の数 - 1/候補の数)の確率で不明になる
ELSE
	RETURNF GET_SPERM_ID("不明")
ENDIF

;死に分岐
RETURNF GET_SPERM_ID("不明")

;---------------------------------------------------------
;中だし履歴を削除する関数
;---------------------------------------------------------
@CLEAR_CREAMPIE_HISTORY(ARG:0, ARG:1 = 0)
;中出し履歴をクリア
FOR LOCAL, 0, WOMB_RECORD_MAX
	WOMB_SPERM_ID:(ARG:0):LOCAL = 0
	WOMB_SPERM_AMOUNT:(ARG:0):LOCAL = 0
	WOMB_SPERM_COUNT:(ARG:0):LOCAL = 0
	WOMB_SPERM_TIME:(ARG:0):LOCAL = 0
	IF ARG:1 == 1
		ANUS_SPERM_TIME:(ARG:0):LOCAL = 0
		ANUS_SPERM_COUNT:(ARG:0):LOCAL = 0
		ANUS_SPERM_AMOUNT:(ARG:0):LOCAL = 0
		STOMACH_SPERM_ID:(ARG:0):LOCAL = 0
		STOMACH_SPERM_TIME:(ARG:0):LOCAL = 0
		STOMACH_SPERM_COUNT:(ARG:0):LOCAL = 0
		STOMACH_SPERM_AMOUNT:(ARG:0):LOCAL = 0
		ANUS_TOTAL_CREAMPIED_AMOUNT:(ARG:0):0 = 0
		STOMACH_TOTAL_CREAMPIED_AMOUNT:(ARG:0):0 = 0
	ENDIF
NEXT
